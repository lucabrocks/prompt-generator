<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Industriekaufmann – Prompt Generator</title>

  <style>
    :root{
      --brand: #001D3B;
      --bg: #f9f9f9;
      --field: #ffffff;
      --field-border: #d7dbe2;
      --muted: #f0f0f0;

      --success: #2e7d32;
      --success-bg: rgba(46,125,50,0.10);
      --danger: #b00020;
    }

    * { box-sizing: border-box; }

    body{
      margin: 30px;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--brand);
      line-height: 1.35;
    }

    .app{
      max-width: 1100px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    header{
      text-align: center;
      margin-bottom: 6px;
    }

    h1{
      margin: 0 0 6px 0;
      font-size: 22px;
      color: var(--brand);
      letter-spacing: 0.2px;
    }

    .sub{
      margin: 0;
      font-size: 13px;
      opacity: 0.85;
    }

    .card{
      background: #fff;
      border: 1px solid rgba(0,29,59,0.08);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.04);
    }

    .layout{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items: start;
    }

    .controls{
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .row{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .field{
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
    }

    label{
      font-weight: bold;
      margin-left: 2px;
      font-size: 14px;
    }

    select, textarea{
      width: 100%;
      font-size: 14px;
      color: var(--brand);
      background: var(--field);
      border: 2px solid var(--field-border);
      border-radius: 10px;
      padding: 10px;
      outline: none;
    }

    select{
      padding: 10px 12px;
      height: 42px;
    }

    textarea{
      width: 100%;
      min-height: 180px;
      padding: 10px;
      resize: vertical;
    }

    .hint{
      font-size: 12px;
      opacity: 0.85;
      margin-top: -2px;
    }

    /* ---------- Datei hinzufügen: Checkbox ---------- */
    .checkRow{
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .checkControl{
      display: inline-flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      user-select: none;
    }

    .checkControl input[type="checkbox"]{
      width: 18px;
      height: 18px;
      margin: 0;
      accent-color: var(--brand);
      cursor: pointer;
    }

    .checkControl span{
      font-size: 14px;
      font-weight: bold;
      margin-left: 2px;
    }

    /* Info "i" neben Checkbox */
    .infoWrap{
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .infoBtn{
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(0,29,59,0.25);
      background: rgba(0,29,59,0.06);
      color: var(--brand);
      font-weight: bold;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      line-height: 1;
      padding: 0;
    }

    .infoBtn:hover{ filter: brightness(1.02); }
    .infoBtn:active{ filter: brightness(0.98); transform: translateY(1px); }

    .infoTooltip{
      display: none;
      position: absolute;
      left: 0;
      top: 30px;
      z-index: 20;
      width: min(520px, 92vw);
      padding: 10px 12px;
      border-radius: 12px;
      background: #fff;
      border: 2px solid rgba(0,29,59,0.18);
      box-shadow: 0 10px 24px rgba(0,0,0,0.08);
      font-size: 13px;
      color: var(--brand);
    }

    .infoTooltip strong{
      display: block;
      margin-bottom: 6px;
    }

    /* Kurz-Popup beim Aktivieren */
    .fileToast{
      display: none;
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,29,59,0.06);
      border: 2px solid rgba(0,29,59,0.18);
      color: var(--brand);
      font-weight: bold;
      font-size: 14px;
    }

    /* Buttons */
    .btnRow{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 2px;
    }

    button{
      border: none;
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.08s ease, filter 0.12s ease, background 0.12s ease;
      user-select: none;
    }

    .btnPrimary{
      background: var(--brand);
      color: #fff;
    }
    .btnPrimary:hover{ filter: brightness(1.05); }
    .btnPrimary:active{ filter: brightness(0.98); transform: translateY(1px); }

    .btnSecondary{
      background: #fff;
      color: var(--brand);
      border: 2px solid var(--field-border);
    }
    .btnSecondary:hover{ filter: brightness(1.03); }
    .btnSecondary:active{ filter: brightness(0.98); transform: translateY(1px); }

    /* kleiner Reminder-Button neben Status */
    .btnMini{
      background: #fff;
      color: var(--brand);
      border: 2px solid rgba(0,29,59,0.18);
      padding: 10px 14px;
      font-size: 14px;
      border-radius: 12px;
    }
    .btnMini:hover{ filter: brightness(1.03); }
    .btnMini:active{ filter: brightness(0.98); transform: translateY(1px); }

    .output{
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    #outputPrompt{
      min-height: 220px;
      background: var(--muted);
    }

    .statusRow{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .status{
      display: none;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: var(--success-bg);
      border: 2px solid rgba(46,125,50,0.35);
      color: var(--success);
      font-weight: bold;
      width: fit-content;
      max-width: 100%;
    }

    .status .check{
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 2px solid var(--success);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      flex: 0 0 auto;
    }

    .status .check svg{
      width: 14px;
      height: 14px;
      display: block;
    }

    .error{
      display: none;
      margin-top: 8px;
      color: var(--danger);
      font-weight: bold;
      font-size: 13px;
    }

    /* ---------- Prompt-Historie ---------- */
    .historyHeader{
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }

    .historyTitle{
      font-weight: bold;
      font-size: 14px;
      margin-left: 2px;
    }

    .historyMeta{
      font-size: 12px;
      opacity: 0.85;
    }

    .historyList{
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 10px;
    }

    .historyEmpty{
      font-size: 13px;
      opacity: 0.85;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,29,59,0.04);
      border: 1px solid rgba(0,29,59,0.10);
    }

    .historyItem{
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(0,29,59,0.04);
      border: 1px solid rgba(0,29,59,0.10);
    }

    .historyItemMain{
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .historyLine1{
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      font-size: 13px;
      font-weight: bold;
    }

    .historyLine2{
      font-size: 12px;
      opacity: 0.9;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .historyActions{
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .btnSmall{
      background: #fff;
      color: var(--brand);
      border: 2px solid rgba(0,29,59,0.18);
      padding: 10px 12px;
      font-size: 13px;
      border-radius: 12px;
      white-space: nowrap;
    }
    .btnSmall:hover{ filter: brightness(1.03); }
    .btnSmall:active{ filter: brightness(0.98); transform: translateY(1px); }

    .btnDanger{
      border-color: rgba(176,0,32,0.25);
      color: var(--danger);
      background: rgba(176,0,32,0.04);
    }

    /* Focus */
    select:focus, textarea:focus, button:focus, .checkControl input[type="checkbox"]:focus, .infoBtn:focus{
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(0, 29, 59, 0.12);
      outline: none;
    }
    button:focus{
      outline: none;
      box-shadow: 0 0 0 3px rgba(0, 29, 59, 0.12);
    }

    footer{
      text-align: center;
      font-size: 13px;
      opacity: 0.85;
      margin-top: 6px;
    }

    @media (max-width: 980px){
      .layout{
        grid-template-columns: 1fr;
      }
      .infoTooltip{ width: min(520px, 92vw); }
    }

    @media (max-width: 700px){
      body{ margin: 16px; }
      .row{ grid-template-columns: 1fr; }
      h1{ font-size: 20px; }
      button{ width: 100%; }
      .btnRow{ align-items: stretch; }
      .status{ width: 100%; justify-content: center; }
      .btnMini{ width: 100%; }
      .statusRow{ align-items: stretch; }
      .historyItem{ grid-template-columns: 1fr; }
      .historyActions{ justify-content: stretch; }
      .btnSmall{ width: 100%; }
    }

    @media (max-width: 420px){
      body{ margin: 12px; }
      .card{ padding: 12px; }
    }
  </style>
</head>

<body>
  <div class="app" role="application" aria-label="Industriekaufmann Prompt Generator">
    <header>
      <h1>Prompt Generator – Industriekaufmann</h1>
      <p class="sub">Wähle Einstellungen, gib deine Aufgabe ein und kopiere den fertigen Prompt.</p>
    </header>

    <div class="layout">
      <!-- INPUT -->
      <section class="card controls" aria-label="Eingaben">
        <div class="row">
          <div class="field">
            <label for="fach">Fach</label>
            <select id="fach" name="fach">
              <option value="GP" selected>GP</option>
              <option value="SuK">SuK</option>
              <option value="WSP">WSP</option>
            </select>
          </div>

          <div class="field">
            <label for="ueberthema">Überthema (optional)</label>
            <select id="ueberthema" name="ueberthema" aria-describedby="ueberthemaHint" aria-label="Überthema (optional)">
              <!-- wird dynamisch befüllt -->
            </select>
            <div id="ueberthemaHint" class="hint">Leer lassen, wenn du kein Überthema angeben willst.</div>
          </div>
        </div>

        <div class="field">
          <label for="frage">Frage/ konkretes Thema (Freitext)</label>
          <textarea id="frage" name="frage" placeholder="Schreibe hier deine Aufgabenstellung oder Frage rein..."></textarea>
        </div>

        <!-- Datei hinzufügen (Checkbox) -->
        <div class="field">
          <div class="checkRow">
            <div class="infoWrap">
              <label class="checkControl" for="includeFile">
                <input id="includeFile" name="includeFile" type="checkbox" />
                <span>Datei hinzufügen</span>
              </label>

              <button id="infoBtn" class="infoBtn" type="button" aria-label="Informationen zu Datei hinzufügen" aria-expanded="false" aria-controls="infoTooltip">i</button>

              <div id="infoTooltip" class="infoTooltip" role="tooltip">
                <strong>Hinweis</strong>
                Wenn du „Datei hinzufügen“ aktivierst, wird im Prompt erwähnt, dass du eine Datei beilegen wirst. ChatGPT soll sich dann in der Antwort darauf beziehen.
              </div>
            </div>
          </div>

          <div id="fileToast" class="fileToast" role="status" aria-live="polite">
            Datei zum Prompt einfügen (bitte beim Antworten berücksichtigen)
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="darstellung">Darstellungsform</label>
            <select id="darstellung" name="darstellung">
              <option value="Karteikarten">Karteikarten</option>
              <option value="ausführliches Skript">ausführliches Skript</option>
              <option value="Aufgabe lösen" selected>Aufgabe lösen</option>
              <option value="Erklärung">Erklärung</option>
            </select>
          </div>

          <div class="field">
            <label for="laenge">Länge</label>
            <select id="laenge" name="laenge">
              <option value="knappe Zusammenfassung/Lösung">knappe Zusammenfassung/Lösung</option>
              <option value="kurze Erläuterung" selected>kurze Erläuterung</option>
              <option value="ausführliche Erklärung">ausführliche Erklärung</option>
            </select>
          </div>
        </div>

        <div class="btnRow" aria-label="Aktionen">
          <button id="btnGenerate" class="btnPrimary" type="button" title="Tastenkürzel: Strg+Enter / Cmd+Enter">Prompt generieren &amp; kopieren</button>
          <button id="btnReset" class="btnSecondary" type="button" title="Tastenkürzel: Esc">Prompt zurücksetzen</button>
        </div>

        <!-- Status + Datei-Reminder -->
        <div class="statusRow" aria-label="Status">
          <div id="status" class="status" role="status" aria-live="polite">
            <span class="check" aria-hidden="true">
              <svg viewBox="0 0 24 24" fill="none">
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"></path>
              </svg>
            </span>
            <span>Prompt erfolgreich kopiert</span>
          </div>

          <button id="fileReminderBtn" class="btnMini" type="button" style="display:none;">
            Denk dran: Datei mit einfügen
          </button>
        </div>

        <div id="error" class="error" role="alert"></div>
      </section>

      <!-- OUTPUT -->
      <section class="card output" aria-label="Ausgabe">
        <div class="field">
          <label for="outputPrompt">Prompt-Ausgabe</label>
          <textarea id="outputPrompt" readonly placeholder="Hier erscheint dein generierter Prompt..."></textarea>
          <div class="hint">Tipp: Der Prompt wird beim Generieren automatisch kopiert. Tastenkürzel: Strg+Enter / Cmd+Enter.</div>
        </div>

        <!-- Prompt-Historie -->
        <div class="field" aria-label="Prompt-Historie">
          <div class="historyHeader">
            <div class="historyTitle">Prompt-Historie (letzte 10)</div>
            <div class="historyMeta">
              <span id="historyCount">0</span>/10 gespeichert • gespeichert im Browser
            </div>
          </div>

          <div class="hint">Klicke „Laden“, um einen früheren Prompt wieder ins Ausgabefeld zu übernehmen. „Kopieren“ kopiert direkt den alten Prompt.</div>

          <div id="historyEmpty" class="historyEmpty" style="display:none;">
            Noch keine Historie vorhanden. Generiere einen Prompt – dann wird er hier gespeichert.
          </div>

          <div id="historyList" class="historyList"></div>

          <div class="btnRow" style="margin-top: 8px;">
            <button id="btnClearHistory" class="btnSecondary" type="button">Historie löschen</button>
          </div>
        </div>
      </section>
    </div>

    <footer>© 2026 Industriekaufmann</footer>
  </div>

  <script>
    const fachEl = document.getElementById('fach');
    const ueberthemaEl = document.getElementById('ueberthema');
    const frageEl = document.getElementById('frage');
    const darstellungEl = document.getElementById('darstellung');
    const laengeEl = document.getElementById('laenge');

    // Datei-Checkbox
    const includeFileEl = document.getElementById('includeFile');
    const fileToastEl = document.getElementById('fileToast');
    let fileToastTimer = null;

    // Info Tooltip
    const infoBtnEl = document.getElementById('infoBtn');
    const infoTooltipEl = document.getElementById('infoTooltip');

    // Reminder Button nach Generieren
    const fileReminderBtnEl = document.getElementById('fileReminderBtn');

    const outputEl = document.getElementById('outputPrompt');
    const btnGenerate = document.getElementById('btnGenerate');
    const btnReset = document.getElementById('btnReset');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');

    // Historie UI
    const historyListEl = document.getElementById('historyList');
    const historyEmptyEl = document.getElementById('historyEmpty');
    const historyCountEl = document.getElementById('historyCount');
    const btnClearHistory = document.getElementById('btnClearHistory');

    let statusTimer = null;

    // Storage Key
    const HISTORY_KEY = "ik_prompt_history_v1";
    const HISTORY_MAX = 10;

    // ÜBERTHEMA-OPTIONEN (pro Fach)
    const BLANK_LABEL = "\u00A0";

    const UEBERTHEMA_OPTIONS = {
      GP: [
        { value: "", label: BLANK_LABEL },
        { value: "Grundlagen BWL", label: "Grundlagen BWL" },
        { value: "Produltionswirtschaft", label: "Produltionswirtschaft" },
        { value: "Beschaffung", label: "Beschaffung" },
        { value: "Personalwirtschaft", label: "Personalwirtschaft" },
        { value: "Absatzprozesse", label: "Absatzprozesse" },
        { value: "Invstition- und Finanzierungsprozesse", label: "Invstition- und Finanzierungsprozesse" }
      ],
      SuK: [
        { value: "", label: BLANK_LABEL },
        { value: "Finanzbuchhaltung", label: "Finanzbuchhaltung" },
        { value: "Kosten- und Leistungsrechnung", label: "Kosten- und Leistungsrechnung" }
      ],
      WSP: [
        { value: "", label: BLANK_LABEL },
        { value: "Wirtschaftsrecht", label: "Wirtschaftsrecht" },
        { value: "Politik", label: "Politik" },
        { value: "VWL", label: "VWL" }
      ]
    };

    const DEFAULTS = {
      fach: "GP",
      ueberthema: "",
      frage: "",
      darstellung: "Aufgabe lösen",
      laenge: "kurze Erläuterung",
      includeFile: false
    };

    function clearStatus() {
      statusEl.style.display = 'none';
      if (statusTimer) {
        clearTimeout(statusTimer);
        statusTimer = null;
      }
    }

    function showStatus() {
      statusEl.style.display = 'flex';
      if (statusTimer) clearTimeout(statusTimer);
      statusTimer = setTimeout(() => {
        statusEl.style.display = 'none';
        statusTimer = null;
      }, 2500);
    }

    function showError(message) {
      errorEl.textContent = message;
      errorEl.style.display = 'block';
      setTimeout(() => {
        errorEl.style.display = 'none';
        errorEl.textContent = '';
      }, 3200);
    }

    function escapePromptText(text) {
      return (text || "").trim();
    }

    function buildFachGlossarBlock(fach) {
      if (fach === "GP") {
        return [
          "Fach-Regeln (GP – Geschäftsprozesse / BWL):",
          "- Themenfokus: Grundlagen BWL, Produktionswirtschaft, Beschaffung, Personalwirtschaft, Absatzprozesse, Investitions- und Finanzierungsprozesse.",
          "- Definitionen immer in genau einem Satz; nutze nur Fachbegriffe, die ein Industriekaufmann erklären kann.",
          "- Bei Vor- und Nachteilen bewerte insbesondere nach Kosten, Zeit, Qualität (und ggf. weitere sinnvolle Kriterien)."
        ].join("\n");
      }

      if (fach === "SuK") {
        return [
          "Fach-Regeln (SuK – Steuerung und Kontrolle / Rechnungswesen):",
          "- Themenfokus: Finanzbuchhaltung, Kosten- und Leistungsrechnung.",
          "- Besonders gründlich arbeiten: alle Zahlen logisch herleiten, Rechenwege sauber und nachvollziehbar darstellen.",
          "- Ergebnis muss stimmen; antworte aus der „Buchhalter-Brille“."
        ].join("\n");
      }

      return [
        "Fach-Regeln (WSP – Wirtschafts- und Sozialprozesse):",
        "- Themenfokus: Wirtschaftsrecht, Politik, VWL.",
        "- Formulierungen müssen wirklich korrekt sein; kleine Fehler können große Probleme machen.",
        "- Wenn Unsicherheit besteht: stelle Rückfragen und fordere ggf. eine Quelle/Screenshot aus OneNote an, bevor du final antwortest."
      ].join("\n");
    }

    function buildDarstellungsformBlock(selectedForm) {
      const commonIntro = [
        "Darstellungsform-Regeln (wende exakt die ausgewählte Darstellungsform an):"
      ];

      const rules = [
        "- Karteikarten (Anki Type: Einfach):",
        "  - Erstelle mehrere kleine Karten statt einer großen: pro Karte genau EIN Begriff/Ein Schritt/Ein Mini-Thema.",
        "  - Vorderseite ist immer eine logische, konkrete Frage.",
        "  - Rückseite ist eine klare, kurze Antwort PLUS eine kleine Erklärung (1–3 Sätze).",
        "  - Niemals alles in einer Karte bündeln; lieber mehr Karten mit kleinen Fragestellungen.",
        "  - Ausgabeformat ist zwingend und exakt (ohne weitere Überschriften, ohne Nummerierung):",
        "    Vorderseite:",
        "    Rückseite:",
        "",
        "    Vorderseite:",
        "    Rückseite:",
        "  - Nach den Karten: Frage den User IMMER, ob er zufrieden ist und ob/welche Änderung er möchte.",
        "  - Wenn der User zufrieden ist (oder nachdem Änderungen eingearbeitet wurden): Frage nochmals, ob du es automatisch als Anki-Deck speichern sollst.",
        "  - Wenn ja: Frage nach dem gewünschten Namen und speichere/es ausgeben als „<Name>.apkg“.",
        "- ausführliches Skript: Sehr ausführlicher Fließtext zum Vorlesen; KEINE Stichpunkte, KEINE Aufzählungen, KEINE Überschriften, nur reiner Fließtext.",
        "- Aufgabe lösen: Aufgabe in sinnvoller Länge vollständig lösen; Rechenwege/Begründungen gemäß Fachregeln.",
        "- Erklärung: Definition mit Erklärung; wenn nötig Beispiele oder Rechnung; Länge so wie nötig."
      ];

      const active = "Ausgewählt: " + selectedForm;
      return [...commonIntro, active, ...rules].join("\n");
    }

    function buildLaengeBlock(selectedLength) {
      return [
        "Längensteuerung (halte dich daran):",
        "- knappe Zusammenfassung/Lösung: kurz und direkt, nur das Wesentliche.",
        "- kurze Erläuterung: etwas ausführlicher, aber nicht unnötig lang.",
        "- ausführliche Erklärung: sehr detailliert, mit Herleitung/Beispielen, je nach Fach.",
        "Ausgewählt: " + selectedLength
      ].join("\n");
    }

    function buildQualityClause(fach) {
      if (fach === "SuK") {
        return "Qualitätsklausel (SuK): Wenn du dir bei einem Rechenschritt unsicher bist, erkläre die Annahme und frage nach fehlenden Angaben.";
      }
      if (fach === "WSP") {
        return "Qualitätsklausel (WSP): Wenn du dir bei einer Rechtsfrage unsicher bist, stelle Rückfragen oder fordere Quelle/Screenshot an, bevor du final antwortest.";
      }
      return "";
    }

    function buildPrompt() {
      const fach = fachEl.value;
      const ueberthema = ueberthemaEl.value;
      const darstellung = darstellungEl.value;
      const laenge = laengeEl.value;

      const frageText = escapePromptText(frageEl.value);
      const includeFile = includeFileEl.checked;

      const contextLines = [
        "Kontext:",
        "- Fach: " + fach
      ];
      if (ueberthema) contextLines.push("- Überthema: " + ueberthema);
      contextLines.push("- Darstellungsform: " + darstellung);
      contextLines.push("- Länge: " + laenge);

      const userInputLines = [
        "Aufgabe/Frage:",
        (frageText ? frageText : "(keine Angabe – bitte Rückfragen stellen, welche Aufgabe genau gemeint ist)")
      ];

      if (includeFile) {
        userInputLines.push("");
        userInputLines.push("Datei angehängt: Bitte beziehe dich in deiner Antwort auf die angefügte Datei (falls relevant).");
      }

      const qualityClause = buildQualityClause(fach);

      const parts = [
        "Du bist ein erfahrener Dozent/Prüfer für Industriekaufleute.",
        "Antworte ausschließlich auf Deutsch.",
        "",
        contextLines.join("\n"),
        "",
        buildFachGlossarBlock(fach),
        "",
        buildDarstellungsformBlock(darstellung),
        "",
        buildLaengeBlock(laenge),
        "",
        userInputLines.join("\n")
      ];

      if (qualityClause) {
        parts.push("");
        parts.push(qualityClause);
      }

      parts.push("");
      parts.push("Wichtig: Antworte präzise, nachvollziehbar und fachlich korrekt. Falls Angaben fehlen, stelle zuerst gezielte Rückfragen.");

      return parts.join("\n");
    }

    // ---------- Clipboard ----------
    async function copyToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        await navigator.clipboard.writeText(text);
        return;
      }

      const temp = document.createElement('textarea');
      temp.value = text;
      temp.setAttribute('readonly', '');
      temp.style.position = 'fixed';
      temp.style.left = '-9999px';
      temp.style.top = '-9999px';
      document.body.appendChild(temp);
      temp.select();
      temp.setSelectionRange(0, temp.value.length);
      const ok = document.execCommand('copy');
      document.body.removeChild(temp);
      if (!ok) throw new Error("Kopieren nicht möglich.");
    }

    // ---------- Übert Thema ----------
    function setUeberthemaOptionsForFach(fach) {
      const options = UEBERTHEMA_OPTIONS[fach] || [{ value: "", label: BLANK_LABEL }];

      ueberthemaEl.innerHTML = "";

      for (const opt of options) {
        const o = document.createElement('option');
        o.value = opt.value;
        o.textContent = opt.label;
        ueberthemaEl.appendChild(o);
      }

      ueberthemaEl.value = "";
      ueberthemaEl.selectedIndex = 0;
    }

    // ---------- Datei-Hinweis (Toast) ----------
    function showFileToast() {
      fileToastEl.style.display = 'block';
      if (fileToastTimer) clearTimeout(fileToastTimer);
      fileToastTimer = setTimeout(() => {
        fileToastEl.style.display = 'none';
        fileToastTimer = null;
      }, 4000);
    }

    // ---------- Info Tooltip ----------
    function closeInfoTooltip() {
      infoTooltipEl.style.display = 'none';
      infoBtnEl.setAttribute('aria-expanded', 'false');
    }

    function toggleInfoTooltip() {
      const isOpen = infoTooltipEl.style.display === 'block';
      if (isOpen) {
        closeInfoTooltip();
      } else {
        infoTooltipEl.style.display = 'block';
        infoBtnEl.setAttribute('aria-expanded', 'true');
      }
    }

    infoBtnEl.addEventListener('click', (e) => {
      e.stopPropagation();
      toggleInfoTooltip();
    });

    document.addEventListener('click', (e) => {
      if (infoTooltipEl.style.display === 'block') {
        const within = infoTooltipEl.contains(e.target) || infoBtnEl.contains(e.target);
        if (!within) closeInfoTooltip();
      }
    });

    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeInfoTooltip();
    });

    includeFileEl.addEventListener('change', () => {
      if (includeFileEl.checked) showFileToast();
      if (!includeFileEl.checked) fileReminderBtnEl.style.display = 'none';
      clearStatus();
    });

    fileReminderBtnEl.addEventListener('click', () => {
      closeInfoTooltip();
      showFileToast();
    });

    // ---------- Prompt-Historie (localStorage) ----------
    function safeJsonParse(str, fallback) {
      try {
        return JSON.parse(str);
      } catch {
        return fallback;
      }
    }

    function loadHistory() {
      const raw = localStorage.getItem(HISTORY_KEY);
      const arr = safeJsonParse(raw, []);
      return Array.isArray(arr) ? arr : [];
    }

    function saveHistory(arr) {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    }

    function getPromptPreview(prompt) {
      const s = (prompt || "").trim();
      if (!s) return "";
      // kleine Vorschau: erste relevante Zeilen nach "Aufgabe/Frage:"
      const idx = s.indexOf("Aufgabe/Frage:");
      if (idx === -1) return s.slice(0, 180);
      const sub = s.slice(idx);
      return sub.replace(/\s+/g, " ").trim().slice(0, 220);
    }

    function formatTimestamp(ts) {
      const d = new Date(ts);
      return d.toLocaleString('de-DE', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
    }

    function buildHistoryLabel(item) {
      const parts = [];
      if (item.fach) parts.push(item.fach);
      if (item.ueberthema) parts.push(item.ueberthema);
      if (item.darstellung) parts.push(item.darstellung);
      if (item.laenge) parts.push(item.laenge);
      const left = parts.join(" • ");
      const right = item.ts ? formatTimestamp(item.ts) : "";
      return { left, right };
    }

    function addToHistory(entry) {
      let hist = loadHistory();

      // Duplikate vermeiden: wenn letzter Prompt identisch ist, nur Timestamp aktualisieren
      if (hist.length > 0 && hist[0].prompt === entry.prompt) {
        hist[0].ts = Date.now();
        saveHistory(hist);
        renderHistory();
        return;
      }

      hist.unshift(entry);
      if (hist.length > HISTORY_MAX) hist = hist.slice(0, HISTORY_MAX);

      saveHistory(hist);
      renderHistory();
    }

    function clearHistory() {
      localStorage.removeItem(HISTORY_KEY);
      renderHistory();
    }

    async function copyHistoryItem(prompt) {
      await copyToClipboard(prompt);
      clearStatus();
      showStatus();
      // Status sichtbar halten + scroll nicht nötig
      // Hinweis: Datei-Reminder nicht automatisch ändern, weil historischer Prompt das enthalten kann
    }

    function loadHistoryItem(prompt) {
      outputEl.value = prompt || "";
      // Output in den sichtbaren Bereich scrollen
      outputEl.scrollIntoView({ behavior: "smooth", block: "center" });
    }

    function renderHistory() {
      const hist = loadHistory();
      historyCountEl.textContent = String(hist.length);

      historyListEl.innerHTML = "";
      historyEmptyEl.style.display = hist.length === 0 ? "block" : "none";

      hist.forEach((item, index) => {
        const wrap = document.createElement('div');
        wrap.className = "historyItem";

        const main = document.createElement('div');
        main.className = "historyItemMain";

        const line1 = document.createElement('div');
        line1.className = "historyLine1";

        const label = buildHistoryLabel(item);
        const leftSpan = document.createElement('span');
        leftSpan.textContent = label.left || "Gespeicherter Prompt";
        const rightSpan = document.createElement('span');
        rightSpan.style.opacity = "0.8";
        rightSpan.style.fontWeight = "normal";
        rightSpan.textContent = label.right ? ("(" + label.right + ")") : "";

        line1.appendChild(leftSpan);
        if (label.right) line1.appendChild(rightSpan);

        const line2 = document.createElement('div');
        line2.className = "historyLine2";
        line2.textContent = item.preview || getPromptPreview(item.prompt);

        main.appendChild(line1);
        main.appendChild(line2);

        const actions = document.createElement('div');
        actions.className = "historyActions";

        const btnLoad = document.createElement('button');
        btnLoad.type = "button";
        btnLoad.className = "btnSmall";
        btnLoad.textContent = "Laden";
        btnLoad.addEventListener('click', () => {
          loadHistoryItem(item.prompt);
          clearStatus();
        });

        const btnCopy = document.createElement('button');
        btnCopy.type = "button";
        btnCopy.className = "btnSmall";
        btnCopy.textContent = "Kopieren";
        btnCopy.addEventListener('click', async () => {
          try {
            await copyHistoryItem(item.prompt);
          } catch (e) {
            showError("Kopieren hat nicht funktioniert. Bitte manuell aus dem Feld „Prompt-Ausgabe“ kopieren.");
          }
        });

        actions.appendChild(btnLoad);
        actions.appendChild(btnCopy);

        wrap.appendChild(main);
        wrap.appendChild(actions);

        historyListEl.appendChild(wrap);
      });
    }

    btnClearHistory.addEventListener('click', () => {
      clearStatus();
      clearHistory();
    });

    // ---------- Reset ----------
    function resetAll() {
      fachEl.value = DEFAULTS.fach;

      setUeberthemaOptionsForFach(DEFAULTS.fach);
      ueberthemaEl.value = DEFAULTS.ueberthema;
      ueberthemaEl.selectedIndex = 0;

      frageEl.value = DEFAULTS.frage;

      darstellungEl.value = DEFAULTS.darstellung;
      laengeEl.value = DEFAULTS.laenge;

      includeFileEl.checked = DEFAULTS.includeFile;
      fileToastEl.style.display = 'none';
      if (fileToastTimer) {
        clearTimeout(fileToastTimer);
        fileToastTimer = null;
      }

      fileReminderBtnEl.style.display = 'none';
      closeInfoTooltip();

      outputEl.value = "";
      clearStatus();
      errorEl.style.display = 'none';
      errorEl.textContent = '';
    }

    // ---------- UX: Fehlermeldung bei leerer Frage ----------
    function validateBeforeGenerate() {
      const txt = escapePromptText(frageEl.value);
      if (!txt) {
        // Deutliche Warnung + Fokus setzen
        showError("Bitte füge zuerst deine Aufgabe/Frage in das Feld „Frage/ konkretes Thema“ ein.");
        frageEl.focus();
        frageEl.scrollIntoView({ behavior: "smooth", block: "center" });
        return false;
      }
      return true;
    }

    // ---------- Generate ----------
    async function generateAndCopy() {
      clearStatus();

      if (!validateBeforeGenerate()) return;

      const prompt = buildPrompt();
      outputEl.value = prompt;

      // Output nach Generieren in Sicht bringen
      outputEl.scrollIntoView({ behavior: "smooth", block: "center" });

      try {
        await copyToClipboard(prompt);
        showStatus();

        // Datei-Reminder UI
        if (includeFileEl.checked) {
          fileReminderBtnEl.style.display = 'inline-flex';
        } else {
          fileReminderBtnEl.style.display = 'none';
        }

        // In Historie speichern
        addToHistory({
          ts: Date.now(),
          fach: fachEl.value,
          ueberthema: ueberthemaEl.value,
          darstellung: darstellungEl.value,
          laenge: laengeEl.value,
          includeFile: includeFileEl.checked,
          preview: getPromptPreview(prompt),
          prompt: prompt
        });

      } catch (err) {
        showError("Kopieren hat nicht funktioniert. Markiere den Text im Feld „Prompt-Ausgabe“ und kopiere manuell (Strg+C).");
      }
    }

    btnGenerate.addEventListener('click', async () => {
      await generateAndCopy();
    });

    btnReset.addEventListener('click', () => {
      resetAll();
    });

    fachEl.addEventListener('change', () => {
      setUeberthemaOptionsForFach(fachEl.value);
      clearStatus();
    });

    // ---------- UX: Tastenkürzel ----------
    // Strg+Enter / Cmd+Enter => Generieren & Kopieren
    // Esc => Reset (und schließt Tooltip/Status)
    document.addEventListener('keydown', (e) => {
      const isEnter = e.key === 'Enter';
      const isEsc = e.key === 'Escape';
      const isMod = e.ctrlKey || e.metaKey;

      // Generieren
      if (isEnter && isMod) {
        e.preventDefault();
        generateAndCopy();
        return;
      }

      // Reset
      if (isEsc) {
        // Tooltip schließen ist schon in Listener oben, aber Reset ist gewünscht
        e.preventDefault();
        clearStatus();
        resetAll();
        return;
      }
    });

    // ---------- Init ----------
    (function init() {
      setUeberthemaOptionsForFach(DEFAULTS.fach);
      ueberthemaEl.value = "";
      ueberthemaEl.selectedIndex = 0;

      darstellungEl.value = DEFAULTS.darstellung;
      laengeEl.value = DEFAULTS.laenge;

      includeFileEl.checked = DEFAULTS.includeFile;
      fileToastEl.style.display = 'none';
      fileReminderBtnEl.style.display = 'none';
      closeInfoTooltip();

      clearStatus();
      renderHistory();
    })();
  </script>
</body>
</html>
